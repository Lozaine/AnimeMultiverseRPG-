// Enhanced Faction System for Cross Realm Chronicles
// Complete faction framework with progression, abilities, and unique mechanics

const FACTIONS = {
    one_piece: {
        name: 'One Piece Pirates',
        emoji: 'ðŸ´â€â˜ ï¸',
        description: 'Set sail on the Grand Line and search for the ultimate treasure! Navigate dangerous waters, battle marine forces, and discover the secrets of Devil Fruits.',
        theme: 'Adventure, Freedom, Treasure Hunting',
        perk: 'Treasure Hunter - Increased coin rewards and rare item discovery rates',
        startingAbility: 'Pirate\'s Intuition',
        startingAbilityDescription: 'Natural instinct for finding hidden treasures and sensing danger (+15% item find rate, +10% critical hit chance)',
        color: '#ff6b35',
        statBonuses: {
            hp: 5,      // Pirates are hardy sailors
            atk: 3,     // Good combat skills
            def: 2,     // Average defense
            spd: 5      // Quick and agile
        },
        questAffinities: ['gathering', 'hunting', 'delivery'], // Best at exploration and adventure
        uniqueMechanics: {
            devilFruitCompatible: true,
            treasureHunting: true,
            navalCombat: true,
            crewBonuses: true
        }
    },
    naruto: {
        name: 'Naruto Shinobi',
        emoji: 'ðŸ¥·',
        description: 'Master the ninja arts and protect your hidden village! Learn ancient techniques, manipulate chakra, and complete dangerous missions for your village.',
        theme: 'Stealth, Ninjutsu, Village Protection',
        perk: 'Shadow Arts - Enhanced stealth missions and chakra techniques effectiveness',
        startingAbility: 'Basic Chakra Control',
        startingAbilityDescription: 'Fundamental chakra manipulation for enhanced physical abilities (+3 to all stats, +20% success rate on stealth missions)',
        color: '#ff8c00',
        statBonuses: {
            hp: 4,      // Trained endurance
            atk: 4,     // Balanced combat training
            def: 3,     // Ninja gear protection
            spd: 8      // Speed and agility focus
        },
        questAffinities: ['protection', 'delivery', 'training'], // Missions and skill development
        uniqueMechanics: {
            chakraTechniques: true,
            stealthMissions: true,
            elementalAffinity: true,
            teamFormations: true
        }
    },
    jujutsu_kaisen: {
        name: 'Jujutsu Sorcerers',
        emoji: 'ðŸ‘ï¸',
        description: 'Exorcise cursed spirits and master forbidden techniques! Harness cursed energy, develop your unique technique, and protect humanity from supernatural threats.',
        theme: 'Supernatural Combat, Cursed Energy, Exorcism',
        perk: 'Cursed Sight - Can detect and gain bonuses against supernatural enemies',
        startingAbility: 'Cursed Energy Manipulation',
        startingAbilityDescription: 'Basic control over cursed energy for combat enhancement (+25% damage against cursed enemies, can sense supernatural threats)',
        color: '#8b5cf6',
        statBonuses: {
            hp: 3,      // Dangerous profession
            atk: 6,     // High offensive capability
            def: 4,     // Cursed energy protection
            spd: 6      // Quick reflexes needed
        },
        questAffinities: ['hunting', 'protection', 'training'], // Combat and threat elimination
        uniqueMechanics: {
            cursedTechniques: true,
            domainExpansion: true,
            cursedEnergyManipulation: true,
            supernaturalDetection: true
        }
    },
    demon_slayer: {
        name: 'Demon Slayers',
        emoji: 'âš”ï¸',
        description: 'Hunt demons and master the art of breathing techniques! Forge special weapons, perfect ancient breathing styles, and protect innocent people from demonic threats.',
        theme: 'Swordsmanship, Breathing Techniques, Demon Hunting',
        perk: 'Total Concentration - Breathing techniques enhance all physical capabilities',
        startingAbility: 'Basic Breathing Technique',
        startingAbilityDescription: 'Fundamental breathing control for enhanced physical performance (+4 ATK, +3 DEF, +15% stamina efficiency)',
        color: '#06d6a0',
        statBonuses: {
            hp: 6,      // Tough demon hunters
            atk: 7,     // Sword mastery focus
            def: 5,     // Combat hardened
            spd: 4      // Disciplined movement
        },
        questAffinities: ['hunting', 'training', 'protection'], // Combat specialization
        uniqueMechanics: {
            breathingStyles: true,
            demonHunting: true,
            swordsmithCrafting: true,
            sunlightWeapons: true
        }
    }
};

// Enhanced faction abilities with logical level progression
const FACTION_ABILITIES = {
    one_piece: [
        {
            level: 3,
            ability: 'Sea Legs',
            description: 'Adapted to life at sea - immune to seasickness and water-based debuffs',
            effect: 'immunity_water_debuffs',
            unlock: 'Complete 5 delivery quests successfully'
        },
        {
            level: 7,
            ability: 'Treasure Sense',
            description: 'Enhanced ability to locate valuable items and hidden caches',
            effect: '+25% item_find_rate, +15% rare_item_chance',
            unlock: 'Find 10 rare items through quests'
        },
        {
            level: 12,
            ability: 'Haki Awakening',
            description: 'Unlock basic Observation and Armament Haki abilities',
            effect: '+20% dodge_chance, +15% critical_damage',
            unlock: 'Win 20 combat encounters and reach level 12'
        },
        {
            level: 18,
            ability: 'Devil Fruit Resonance',
            description: 'Enhanced compatibility with Devil Fruit powers (if obtained)',
            effect: 'devil_fruit_power_boost, +30% special_ability_chance',
            unlock: 'Complete a legendary treasure quest'
        },
        {
            level: 25,
            ability: 'Conqueror\'s Will',
            description: 'Rare Conqueror\'s Haki - can intimidate weaker enemies into fleeing',
            effect: 'enemy_intimidation, +25% leadership_bonus',
            unlock: 'Defeat 3 boss-level enemies and demonstrate true leadership'
        }
    ],
    naruto: [
        {
            level: 4,
            ability: 'Shadow Clone Technique',
            description: 'Create shadow clones to assist with tasks and training',
            effect: 'double_training_xp, +30% multi_task_efficiency',
            unlock: 'Complete 10 training quests'
        },
        {
            level: 8,
            ability: 'Elemental Affinity',
            description: 'Discover and develop your primary chakra nature (Fire, Water, Earth, Wind, Lightning)',
            effect: '+40% damage_with_chosen_element, elemental_technique_access',
            unlock: 'Master basic chakra control and complete elemental assessment'
        },
        {
            level: 13,
            ability: 'Advanced Ninjutsu',
            description: 'Master higher-level ninja techniques and stealth abilities',
            effect: '+50% stealth_mission_success, jutsu_combination_attacks',
            unlock: 'Complete 15 protection quests with perfect stealth rating'
        },
        {
            level: 19,
            ability: 'Sage Mode Training',
            description: 'Begin training to harness natural energy and achieve Sage Mode',
            effect: '+35% all_stats_in_combat, nature_energy_techniques',
            unlock: 'Achieve perfect chakra control and find a sage mentor'
        },
        {
            level: 28,
            ability: 'Tailed Beast Partnership',
            description: 'Form a bond with a tailed beast or access similar power source',
            effect: 'massive_power_boost, transformation_abilities, +100% emergency_power',
            unlock: 'Prove worthiness through trials and form spiritual bond'
        }
    ],
    jujutsu_kaisen: [
        {
            level: 5,
            ability: 'Cursed Technique Development',
            description: 'Develop your unique innate cursed technique',
            effect: 'unique_personal_ability, +30% cursed_energy_efficiency',
            unlock: 'Survive 15 supernatural encounters'
        },
        {
            level: 9,
            ability: 'Reverse Cursed Technique',
            description: 'Learn to use cursed energy for healing and restoration',
            effect: 'heal_self_and_others, +50% recovery_rate, curse_removal',
            unlock: 'Master cursed energy control and help heal 5 allies'
        },
        {
            level: 15,
            ability: 'Simple Domain',
            description: 'Create a basic barrier technique for protection and combat',
            effect: 'defensive_barrier, +25% defense_in_domain, technique_nullification',
            unlock: 'Successfully defend against a domain expansion'
        },
        {
            level: 22,
            ability: 'Domain Expansion',
            description: 'Manifest your innate domain with guaranteed hit effects',
            effect: 'personal_domain_space, guaranteed_technique_hits, +75% power_in_domain',
            unlock: 'Perfect your cursed technique and understand your inner self'
        },
        {
            level: 30,
            ability: 'Maximum Technique',
            description: 'Ultimate expression of your cursed technique at maximum output',
            effect: 'technique_mastery_pinnacle, devastating_finishing_moves, +200% technique_power',
            unlock: 'Push beyond all limits in a life-or-death situation'
        }
    ],
    demon_slayer: [
        {
            level: 4,
            ability: 'Breathing Style Mastery',
            description: 'Master a specific breathing style (Water, Thunder, Flame, Stone, Wind, etc.)',
            effect: '+20% technique_damage, breathing_style_forms_unlock',
            unlock: 'Train intensively and choose your breathing style path'
        },
        {
            level: 8,
            ability: 'Enhanced Blade Techniques',
            description: 'Advanced swordsmanship with breathing-enhanced strikes',
            effect: '+35% sword_damage, technique_combinations, +15% critical_rate',
            unlock: 'Master first 5 forms of your breathing style'
        },
        {
            level: 14,
            ability: 'Demon Slayer Mark',
            description: 'Manifest the demon slayer mark for enhanced physical abilities',
            effect: '+50% all_physical_stats, enhanced_demon_detection, mark_resonance',
            unlock: 'Face extreme danger and push past normal human limits'
        },
        {
            level: 20,
            ability: 'See-Through World',
            description: 'Perceive the flow of battle and enemy weak points clearly',
            effect: 'enemy_weakness_detection, +40% accuracy, battle_prediction',
            unlock: 'Achieve perfect breathing technique and mental clarity'
        },
        {
            level: 26,
            ability: 'Breathing Style Evolution',
            description: 'Create your own unique breathing style or master multiple styles',
            effect: 'personal_technique_creation, multi_style_mastery, +100% breathing_efficiency',
            unlock: 'Transcend traditional limits and innovate new techniques'
        }
    ]
};

// Faction-specific quest modifiers and bonuses
const FACTION_QUEST_BONUSES = {
    one_piece: {
        gathering: { xp: 1.2, coins: 1.4, items: 1.25 }, // Great at treasure hunting
        delivery: { xp: 1.3, coins: 1.2, items: 1.1 },   // Excellent navigators
        hunting: { xp: 1.1, coins: 1.1, items: 1.15 },   // Decent combat
        protection: { xp: 1.0, coins: 1.0, items: 1.0 }, // Average
        training: { xp: 0.9, coins: 0.8, items: 1.0 },   // Less formal training
        community: { xp: 0.8, coins: 0.9, items: 1.0 },  // Outsiders
        errand: { xp: 1.1, coins: 1.1, items: 1.0 }      // Good at odd jobs
    },
    naruto: {
        protection: { xp: 1.4, coins: 1.3, items: 1.2 }, // Mission specialists
        delivery: { xp: 1.3, coins: 1.1, items: 1.1 },   // Excellent messengers
        training: { xp: 1.5, coins: 1.0, items: 1.3 },   // Training focused
        hunting: { xp: 1.2, coins: 1.1, items: 1.1 },    // Good hunters
        community: { xp: 1.1, coins: 1.0, items: 1.0 },  // Village protectors
        gathering: { xp: 1.0, coins: 1.0, items: 1.1 },  // Average
        errand: { xp: 1.2, coins: 1.0, items: 1.0 }      // Mission experience
    },
    jujutsu_kaisen: {
        hunting: { xp: 1.4, coins: 1.2, items: 1.3 },    // Supernatural hunters
        protection: { xp: 1.3, coins: 1.2, items: 1.2 }, // Protectors of humanity
        training: { xp: 1.3, coins: 1.0, items: 1.4 },   // Technique development
        gathering: { xp: 1.1, coins: 1.0, items: 1.2 },  // Cursed item detection
        community: { xp: 0.9, coins: 0.8, items: 1.0 },  // Secretive organization
        delivery: { xp: 1.0, coins: 1.0, items: 1.0 },   // Average
        errand: { xp: 0.8, coins: 0.9, items: 1.1 }      // Below average at mundane tasks
    },
    demon_slayer: {
        hunting: { xp: 1.5, coins: 1.3, items: 1.4 },    // Demon hunting specialists
        training: { xp: 1.4, coins: 1.0, items: 1.3 },   // Intensive training culture
        protection: { xp: 1.2, coins: 1.1, items: 1.2 }, // Protectors of the innocent
        community: { xp: 1.1, coins: 1.0, items: 1.1 },  // Helpers of people
        gathering: { xp: 1.0, coins: 1.0, items: 1.2 },  // Average, but good at finding materials
        delivery: { xp: 1.0, coins: 1.0, items: 1.0 },   // Average
        errand: { xp: 0.9, coins: 0.9, items: 1.0 }      // Focused on bigger threats
    }
};

// Faction-specific starting equipment and items
const FACTION_STARTING_GEAR = {
    one_piece: {
        weapon: 'ðŸ—¡ï¸ Cutlass',
        armor: 'ðŸ§¥ Pirate Coat',
        accessory: 'ðŸ§­ Navigator\'s Compass',
        consumables: [
            { name: 'ðŸ– Sea King Meat', description: 'Restores 15 HP', quantity: 2 },
            { name: 'ðŸ—ºï¸ Treasure Map Fragment', description: 'Hints at hidden treasure', quantity: 1 }
        ]
    },
    naruto: {
        weapon: 'ðŸ—¡ï¸ Kunai Set',
        armor: 'ðŸ¥‹ Ninja Gear',
        accessory: 'ðŸ“œ Chakra Paper',
        consumables: [
            { name: 'ðŸ’Š Soldier Pill', description: 'Restores stamina and 10 HP', quantity: 3 },
            { name: 'ðŸ’¨ Smoke Bomb', description: 'Escape from combat', quantity: 2 }
        ]
    },
    jujutsu_kaisen: {
        weapon: 'âš”ï¸ Cursed Tool (Basic)',
        armor: 'ðŸ‘” Sorcerer Uniform',
        accessory: 'ðŸ‘ï¸ Cursed Energy Detector',
        consumables: [
            { name: 'ðŸ’‰ Cursed Energy Serum', description: 'Restores cursed energy', quantity: 2 },
            { name: 'ðŸ›¡ï¸ Protective Charm', description: 'Reduces curse damage', quantity: 1 }
        ]
    },
    demon_slayer: {
        weapon: 'âš”ï¸ Nichirin Blade',
        armor: 'ðŸ¥‹ Demon Slayer Corps Uniform',
        accessory: 'ðŸ“¿ Warding Charm',
        consumables: [
            { name: 'ðŸ’Š Recovery Pill', description: 'Restores 20 HP over time', quantity: 2 },
            { name: 'ðŸŒ… Sunlight Essence', description: 'Extra damage vs demons', quantity: 1 }
        ]
    }
};

// Faction relationships and interactions
const FACTION_RELATIONSHIPS = {
    one_piece: {
        allies: [],
        neutral: ['demon_slayer', 'naruto'],
        rivals: ['jujutsu_kaisen'], // Different approaches to supernatural
        philosophy: 'Freedom above all, adventure and dreams drive us forward'
    },
    naruto: {
        allies: ['demon_slayer'], // Similar dedication to protection
        neutral: ['one_piece'],
        rivals: ['jujutsu_kaisen'], // Different views on power
        philosophy: 'Protect those precious to you, never give up on your dreams'
    },
    jujutsu_kaisen: {
        allies: [],
        neutral: ['demon_slayer'],
        rivals: ['one_piece', 'naruto'], // More pragmatic approach
        philosophy: 'Power exists to protect the weak, even if they never know'
    },
    demon_slayer: {
        allies: ['naruto'], // Shared protective values
        neutral: ['one_piece', 'jujutsu_kaisen'],
        rivals: [],
        philosophy: 'Dedication, discipline, and protecting innocent lives'
    }
};

// Utility functions for faction system
function getFactionBonus(factionId, questCategory) {
    return FACTION_QUEST_BONUSES[factionId]?.[questCategory] || { xp: 1.0, coins: 1.0, items: 1.0 };
}

function getFactionAbilityAtLevel(factionId, level) {
    const abilities = FACTION_ABILITIES[factionId] || [];
    return abilities.filter(ability => ability.level <= level);
}

function getNextFactionAbility(factionId, currentLevel) {
    const abilities = FACTION_ABILITIES[factionId] || [];
    return abilities.find(ability => ability.level > currentLevel);
}

function calculateFactionStats(factionId, baseStats) {
    const faction = FACTIONS[factionId];
    if (!faction || !faction.statBonuses) return baseStats;
    
    return {
        hp: baseStats.hp + faction.statBonuses.hp,
        max_hp: baseStats.max_hp + faction.statBonuses.hp,
        atk: baseStats.atk + faction.statBonuses.atk,
        def: baseStats.def + faction.statBonuses.def,
        spd: baseStats.spd + faction.statBonuses.spd
    };
}

function getFactionStartingGear(factionId) {
    return FACTION_STARTING_GEAR[factionId] || null;
}

function getFactionRelationship(factionId1, factionId2) {
    const relationships = FACTION_RELATIONSHIPS[factionId1];
    if (!relationships) return 'neutral';
    
    if (relationships.allies.includes(factionId2)) return 'ally';
    if (relationships.rivals.includes(factionId2)) return 'rival';
    return 'neutral';
}

function isQuestAffinityMatch(factionId, questCategory) {
    const faction = FACTIONS[factionId];
    return faction && faction.questAffinities.includes(questCategory);
}

module.exports = {
    FACTIONS,
    FACTION_ABILITIES,
    FACTION_QUEST_BONUSES,
    FACTION_STARTING_GEAR,
    FACTION_RELATIONSHIPS,
    getFactionBonus,
    getFactionAbilityAtLevel,
    getNextFactionAbility,
    calculateFactionStats,
    getFactionStartingGear,
    getFactionRelationship,
    isQuestAffinityMatch
};